<!doctype html>
<html>

<head>
  <title>ttVision | Home</title>
  <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css" >
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic" >
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/milligram/1.3.0/milligram.min.css" >
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" >
  <script src="http://player.twitch.tv/js/embed/v1.js"></script>
  <style>
    #main-player {
      width: 100%;
      height: 38em;
    }
    .button {
      margin-top: 10px;
      display: block;
    }
  </style>
  <script type="text/javascript">
    var player;
    var options;
    var channels = ['monstercat', 'food', 'twitchplayspokemon'];
    var channelidx = 0;

    window.onload = function() {
      getFollows();
      options = {
        width: "100%",
        height: "100%",
        channel: channels[0]
      };
      player = new Twitch.Player("main-player", options);
      player.setVolume(0.5);
      player.setMuted(true);
    }

    function toggleMute() {
      if (player.getMuted()) {
        player.setMuted(false);
        document.querySelector("#mute").innerHTML = '<i id="mute" class="fa fa-volume-up"></i> Mute';
      } else {
        player.setMuted(true);
        document.querySelector("#mute").innerHTML = '<i class="fa fa-volume-off fa-lg"></i><i class="fa fa-ban fa-stack-lg"></i> Unmute';
      }
    }

    function nextChannel() {
      channelidx += 1;
      if (channelidx >= channels.length) {
        channelidx = 0;
      }
      player.setChannel(channels[channelidx]);
    }

    function prevChannel() {
      channelidx -= 1;
      if (channelidx <= 0) {
        channelidx = channels.length - 1;
      }
      player.setChannel(channels[channelidx]);
    }

    function setChannels(body) {
      //add channels to local array
      //data = JSON.parse(body);
      //console.log('data ' + body)
      channels = body.channels;
      channelidx = 0;
      player.setChannel(channels[channelidx]);
    }

    function getFollows() {
      var code = getCookie('code');
      //console.log('code ' + code);
      var opts = {
        method: 'GET',
        headers: {}
      }
      fetch('http://ttvision.cc/api?code='+code, opts).then(function (response){
        return(response.json());
      }).then(function(j) {
        console.log('res ' + JSON.stringify(j));
        setChannels(j);
      });
    }

    //http://www.w3schools.com/js/js_cookies.asp
    function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0) == ' ') {
        c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
      }
    }
    return "";
}
  </script>
</head>

<body>
  <div class="container">
    <div class="row">
      <div class="column">
        <h1>ttVision</h1>
      </div>
    </div>

    <div class="row">
      <div class="column">
        <div id="main-player"></div>
      </div>
    </div>

    <div class="row" id="menubar">
      <div class="column column-25">
        <a class="button" id="prev" href="#" onclick="prevChannel()"><i class="fa fa-fast-backward"></i> Prev Channel</a>
      </div>
      <div class="column column-25">
        <a class="button" id="mute" href="#" onclick="toggleMute()"><i class="fa fa-volume-off fa-lg"></i><i class="fa fa-ban fa-stack-lg"></i> Unmute</a>
      </div>
      <div class="column column-25">
        <a class="button" id="dunno" href="#" onclick="getFollows()"><i class="fa fa-refresh"></i> refresh</a>
      </div>
      <div class="column column-25">
        <a class="button" id="next" href="#" onclick="nextChannel()"><i class="fa fa-fast-forward"></i> Next Channel</a>
      </div>

    </div>
  </div>
</body>

</html>
